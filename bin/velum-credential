#!/usr/bin/env bash
# velum-credential - Encrypted vault management for velum-vpn
# Manages secure storage of provider credentials using Argon2id + AES-256-GCM

set -euo pipefail

# ============================================================================
# INITIALIZATION
# ============================================================================

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
VELUM_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"
export VELUM_ROOT

# Source libraries
source "$VELUM_ROOT/lib/velum-core.sh"
source "$VELUM_ROOT/lib/velum-credential.sh"
source "$VELUM_ROOT/lib/velum-vault.sh"

# ============================================================================
# USAGE
# ============================================================================

usage() {
  cat << 'EOF'
velum-credential - Encrypted vault management

USAGE
    velum credential <command> [options]

COMMANDS
    init              Initialize the credential vault (first-time setup)
    status            Show vault status
    store <provider>  Store a credential in the vault
    clear [provider]  Remove credential(s) from vault
    migrate           Clean up insecure files (plaintext creds, session material on disk)

OPTIONS
    -h, --help        Show this help message

DESCRIPTION
    The credential vault provides optional encrypted storage for provider
    account credentials. This is an OPT-IN feature - by default, velum
    prompts for credentials each time and never stores them.

    The vault uses:
    - Argon2id for memory-hard password-based key derivation
    - AES-256-CBC with HMAC-SHA256 for authenticated encryption
    - Salt stored in ~/.config/velum/vault/
    - Vault password required for each operation (never cached)

WORKFLOW
    1. velum credential init           # Create vault (one-time)
    2. velum credential store mullvad  # Store account number
    3. velum connect                   # Prompts for vault password when needed

SECURITY NOTES
    - Credentials are encrypted at rest using your vault password
    - Vault password is requested each time - never cached
    - Use a strong, unique password for the vault
    - This is for ACCOUNT CREDENTIALS only, not session tokens
    - Session material (WireGuard keys, tokens) stored in tmpfs (RAM)
    - Run 'velum credential migrate' to clean up legacy disk storage

EXAMPLES
    velum credential init              # First-time vault setup
    velum credential status            # Check vault state
    velum credential store mullvad     # Store Mullvad account
    velum credential clear mullvad     # Remove Mullvad credential
    velum credential clear             # Remove all credentials

EOF
}

# ============================================================================
# COMMANDS
# ============================================================================

# Initialize vault
cmd_init() {
  echo
  echo "${C_BOLD}Vault Initialization${C_RESET}"
  echo "===================="
  echo

  # Check dependencies
  if ! vault_check_dependencies; then
    echo
    print_error "Missing required tools. Install them and try again."
    exit 1
  fi

  if vault_is_initialized; then
    print_warn "Vault is already initialized."
    echo
    echo "Current status:"
    cmd_status
    return 0
  fi

  print_info "The vault will securely store your provider credentials."
  print_info "You will need to set a password to encrypt the vault."
  echo
  print_warn "IMPORTANT: If you forget this password, stored credentials cannot be recovered."
  echo

  if ! ask_yn "Create a new credential vault?" "y"; then
    echo "Cancelled."
    return 0
  fi

  echo

  # Get password with confirmation (loop until valid)
  local password password2
  while true; do
    password=$(ask_password "Enter vault password")

    if [[ -z "$password" ]]; then
      print_error "Password cannot be empty"
      echo
      continue
    fi

    if [[ ${#password} -lt 8 ]]; then
      print_error "Password must be at least 8 characters"
      echo
      unset password
      continue
    fi

    password2=$(ask_password "Confirm vault password")

    if [[ "$password" != "$password2" ]]; then
      print_error "Passwords do not match"
      echo
      unset password password2
      continue
    fi

    unset password2
    break
  done

  # Initialize vault
  if ! vault_init; then
    print_error "Failed to initialize vault"
    unset password
    exit 1
  fi

  # Validate the password works by testing key derivation
  if vault_validate_password "$password"; then
    print_ok "Vault created successfully!"
    echo
    print_info "You can now store credentials with: velum credential store <provider>"
  else
    print_error "Vault created but password validation failed"
  fi

  unset password
}

# Show vault status
cmd_status() {
  echo
  echo "${C_BOLD}Vault Status${C_RESET}"
  echo "============"
  echo

  if ! vault_is_initialized; then
    echo "Initialized:  ${C_YELLOW}No${C_RESET}"
    echo
    print_info "Run 'velum credential init' to create a vault."
    echo
    return 0
  fi

  echo "Initialized:  ${C_GREEN}Yes${C_RESET}"

  if vault_has_credentials; then
    echo "Credentials:  ${C_GREEN}Stored${C_RESET} (encrypted)"
    echo
    print_info "Enter vault password to view stored providers."
    local password
    password=$(ask_password "Vault password")

    if [[ -n "$password" ]]; then
      local provider_list
      provider_list=$(vault_list_providers "$password" 2>/dev/null) || true

      if [[ -n "$provider_list" ]]; then
        local count
        count=$(echo "$provider_list" | wc -l | tr -d ' ')
        echo
        echo "Stored credentials: $count"
        echo "Providers:"
        echo "$provider_list" | while read -r p; do
          echo "  - $p"
        done
      else
        echo
        print_error "Invalid password or no credentials found"
      fi
      unset password
    fi
  else
    echo "Credentials:  ${C_YELLOW}None stored${C_RESET}"
  fi

  echo
}

# Store credential
cmd_store() {
  local provider="${1:-}"

  if [[ -z "$provider" ]]; then
    print_error "Provider name required"
    echo "Usage: velum credential store <provider>"
    echo "Example: velum credential store mullvad"
    exit 1
  fi

  # Normalize provider name
  provider="${provider,,}"  # lowercase

  echo
  echo "${C_BOLD}Store Credential${C_RESET}"
  echo "================"
  echo

  # Check dependencies
  if ! vault_check_dependencies; then
    print_error "Missing required tools"
    exit 1
  fi

  # Check if vault exists
  if ! vault_is_initialized; then
    print_error "Vault not initialized"
    print_info "Run 'velum credential init' first"
    exit 1
  fi

  # Provider-specific prompts
  local credential_prompt credential_hint
  case "$provider" in
    mullvad)
      credential_prompt="Mullvad account number (16 digits)"
      credential_hint="Your Mullvad account number from https://mullvad.net/account"
      ;;
    ivpn)
      credential_prompt="IVPN account ID (i-XXXX-XXXX-XXXX or ivpn-XXXX-XXXX-XXXX)"
      credential_hint="Your IVPN account ID from https://www.ivpn.net/account"
      ;;
    *)
      credential_prompt="Account credential for $provider"
      credential_hint=""
      ;;
  esac

  echo "Provider: $provider"
  if [[ -n "$credential_hint" ]]; then
    echo "$credential_hint"
  fi
  echo

  # Get credential first
  local credential
  credential=$(ask_password "$credential_prompt")

  if [[ -z "$credential" ]]; then
    print_error "Credential cannot be empty"
    exit 1
  fi

  # Provider-specific validation
  case "$provider" in
    mullvad)
      # Mullvad accounts are 16 digits
      if [[ ! "$credential" =~ ^[0-9]{16}$ ]]; then
        print_error "Invalid Mullvad account format (must be 16 digits)"
        unset credential
        exit 1
      fi
      ;;
    ivpn)
      # IVPN accounts are i-XXXX-XXXX-XXXX or ivpn-XXXX-XXXX-XXXX
      if [[ ! "$credential" =~ ^(i|ivpn)-[a-zA-Z0-9]{4}-[a-zA-Z0-9]{4}-[a-zA-Z0-9]{4}$ ]]; then
        print_error "Invalid IVPN account format"
        unset credential
        exit 1
      fi
      ;;
  esac

  # Now ask for vault password to encrypt
  echo
  local password
  password=$(ask_password "Vault password")

  if [[ -z "$password" ]]; then
    print_error "Vault password is required"
    unset credential
    exit 1
  fi

  # Store credential (validates password during encryption)
  if vault_store_credential "$provider" "$credential" "$password"; then
    print_ok "Credential stored for $provider"
  else
    print_error "Failed to store credential (wrong password?)"
    unset credential password
    exit 1
  fi

  unset credential password
}

# Clear credential(s)
cmd_clear() {
  local provider="${1:-}"

  echo
  echo "${C_BOLD}Clear Credentials${C_RESET}"
  echo "================="
  echo

  if ! vault_is_initialized; then
    print_info "Vault not initialized - nothing to clear"
    return 0
  fi

  if ! vault_has_credentials; then
    print_info "No credentials stored in vault"
    return 0
  fi

  if [[ -z "$provider" ]]; then
    # Clear all credentials
    print_warn "This will remove ALL stored credentials from the vault."

    if ! ask_yn "Clear all credentials?" "n"; then
      echo "Cancelled."
      return 0
    fi

    vault_clear_all
    print_ok "All credentials cleared"
  else
    # Clear specific provider
    provider="${provider,,}"

    if ! ask_yn "Remove credential for $provider?" "y"; then
      echo "Cancelled."
      return 0
    fi

    # Ask for vault password
    local password
    password=$(ask_password "Vault password")

    if [[ -z "$password" ]]; then
      print_error "Vault password is required"
      exit 1
    fi

    if vault_clear_credential "$provider" "$password"; then
      print_ok "Credential cleared for $provider"
    else
      print_error "Failed to clear credential (wrong password?)"
      unset password
      exit 1
    fi

    unset password
  fi
}

# Migrate/cleanup plaintext credentials
cmd_migrate() {
  echo
  echo "${C_BOLD}Credential Migration${C_RESET}"
  echo "===================="
  echo

  print_info "Checking for plaintext credential files..."
  echo

  # Use the function from velum-credential.sh
  migrate_plaintext_credentials

  echo
  print_info "Checking for session files on disk (should be in tmpfs)..."
  echo

  # Clean up WireGuard keys, tokens, etc. from disk storage
  # Track if we deleted anything that requires re-auth
  local had_session_files=false
  local legacy_tokens_dir="${VELUM_TOKENS_DIR:-$HOME/.config/velum/tokens}"

  if [[ -f "${legacy_tokens_dir}/token" ]] || \
     [[ -f "${legacy_tokens_dir}/mullvad_token" ]] || \
     [[ -f "${legacy_tokens_dir}/ivpn_token" ]]; then
    had_session_files=true
  fi

  cleanup_legacy_session_files

  echo
  print_info "Checking for cached vault keys (should not exist with inline unlock)..."
  echo

  # Clean up any cached vault keys from old unlock model
  cleanup_vault_key_cache

  # If we deleted auth tokens, user needs to re-authenticate
  if [[ "$had_session_files" == true ]]; then
    echo
    print_warn "Session files were removed. You will need to re-authenticate."
    echo
    echo "Next steps:"
    echo "  1. Run: velum config     (re-authenticate with your provider)"
    echo "  2. Run: sudo velum connect"
    echo
    echo "Note: WireGuard keys are automatically regenerated on connect."
    echo "      If you have credentials in the vault, you'll be prompted to use them."
  fi
}

# ============================================================================
# MAIN
# ============================================================================

main() {
  if [[ $# -lt 1 ]]; then
    usage
    exit 0
  fi

  local cmd="$1"
  shift

  case "$cmd" in
    init)
      cmd_init "$@"
      ;;
    status)
      cmd_status "$@"
      ;;
    store)
      cmd_store "$@"
      ;;
    clear)
      cmd_clear "$@"
      ;;
    migrate)
      cmd_migrate "$@"
      ;;
    -h|--help|help)
      usage
      ;;
    *)
      print_error "Unknown command: $cmd"
      echo "Run 'velum credential --help' for usage."
      exit 1
      ;;
  esac
}

main "$@"
