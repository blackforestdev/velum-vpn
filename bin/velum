#!/usr/bin/env bash
# velum - Unified CLI for velum-vpn
# Main entry point that dispatches to subcommands

set -euo pipefail

# ============================================================================
# INITIALIZATION
# ============================================================================

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
VELUM_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"
export VELUM_ROOT

# Version
VELUM_VERSION="0.1.0-dev"

# ============================================================================
# USAGE
# ============================================================================

usage() {
  cat << EOF
velum-vpn v${VELUM_VERSION} - Security-focused VPN management

A provider-agnostic VPN management suite for WireGuard with defense-in-depth
security features including kill switch, IPv6 leak prevention, and DNS protection.

USAGE
    velum <command> [options]

COMMANDS
    config          Configure VPN settings interactively
    config lint     Validate configuration file for errors
    connect         Connect to VPN (requires sudo)
    disconnect      Disconnect from VPN (requires sudo)
    status          Show connection status (sudo for full details)
    test            Comprehensive leak and connection testing (requires sudo)
    killswitch      Manage kill switch independently
    webrtc          Open browser for WebRTC leak test
    monitor         VPN health monitoring daemon

OPTIONS
    -h, --help      Show this help message
    -v, --version   Show version information

QUICK START
    1. velum config           # Configure VPN (interactive wizard)
    2. sudo velum connect     # Connect to VPN
    3. sudo velum test        # Verify no leaks
    4. sudo velum status      # Check connection status
    5. sudo velum disconnect  # Disconnect when done

SECURITY FEATURES
    - Kill switch: Blocks all traffic if VPN drops
    - IPv6 protection: Disabled at interface and firewall level
    - DNS leak protection: Routes DNS through VPN tunnel
    - Encrypted fallback: Quad9 (9.9.9.9) as secondary DNS

SUPPORTED PROVIDERS
    - PIA (Private Internet Access) - Port forwarding, Dedicated IP
    - Mullvad - Privacy-focused, no account info required
    - IVPN - Privacy-focused, open source, audited

CONFIGURATION
    Config file:    ~/.config/velum/velum.conf
    Tokens:         ~/.config/velum/tokens/
    Runtime (Linux): /run/velum/
    Runtime (macOS): /var/run/velum/

COMMAND HELP
    velum <command> --help    # Get help for specific command

MORE INFO
    Documentation:  https://github.com/blackforestdev/velum-vpn
    Report issues:  https://github.com/blackforestdev/velum-vpn/issues

EOF
}

# ============================================================================
# MAIN
# ============================================================================

main() {
  if [[ $# -lt 1 ]]; then
    usage
    exit 0
  fi

  local cmd="$1"
  shift

  case "$cmd" in
    config)
      exec "$SCRIPT_DIR/velum-config" "$@"
      ;;
    connect)
      exec "$SCRIPT_DIR/velum-connect" "$@"
      ;;
    disconnect)
      exec "$SCRIPT_DIR/velum-disconnect" "$@"
      ;;
    status)
      exec "$SCRIPT_DIR/velum-status" "$@"
      ;;
    test)
      exec "$SCRIPT_DIR/velum-test" "$@"
      ;;
    killswitch|ks)
      exec "$SCRIPT_DIR/velum-killswitch" "$@"
      ;;
    webrtc)
      exec "$SCRIPT_DIR/velum-webrtc" "$@"
      ;;
    monitor)
      exec "$SCRIPT_DIR/velum-monitor" "$@"
      ;;
    -v|--version|version)
      echo "velum-vpn version $VELUM_VERSION"
      ;;
    -h|--help|help)
      usage
      ;;
    *)
      echo "Unknown command: $cmd" >&2
      echo "Run 'velum --help' for usage." >&2
      exit 1
      ;;
  esac
}

main "$@"
