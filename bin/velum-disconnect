#!/usr/bin/env bash
# velum-disconnect - Cleanly disconnect from VPN
# Handles: WireGuard teardown, kill switch disable, IPv6 restore, DNS restore

set -euo pipefail

# ============================================================================
# INITIALIZATION
# ============================================================================

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
VELUM_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"
export VELUM_ROOT

# Source libraries
source "$VELUM_ROOT/lib/velum-core.sh"
source "$VELUM_ROOT/lib/os/detect.sh"
source "$VELUM_ROOT/lib/velum-credential.sh"

# WireGuard config path
WG_CONF_PATH="/etc/wireguard/velum.conf"

# Runtime directory (VELUM_RUN_DIR from velum-core.sh is OS-specific)

# ============================================================================
# DISCONNECT
# ============================================================================

stop_port_forwarding() {
  local pf_pid_file="$VELUM_RUN_DIR/pf.pid"
  if [[ -f "$pf_pid_file" ]]; then
    local pid
    pid=$(cat "$pf_pid_file" 2>/dev/null || echo "")
    if [[ -n "$pid" ]] && kill -0 "$pid" 2>/dev/null; then
      log_info "Stopping port forwarding keepalive..."
      kill "$pid" 2>/dev/null || true
    fi
    rm -f "$pf_pid_file" "$VELUM_RUN_DIR/pf.port"
  fi
}

stop_wireguard() {
  log_info "Stopping WireGuard..."

  if wg-quick down "$WG_CONF_PATH" 2>/dev/null; then
    print_ok "WireGuard interface stopped"
  else
    print_warn "WireGuard interface was not running"
  fi
}

restore_ipv6() {
  log_info "Restoring IPv6..."

  if os_enable_ipv6 2>/dev/null; then
    print_ok "IPv6 restored on all interfaces"
  else
    print_warn "Could not restore IPv6 on some interfaces"
  fi
}

restore_dns() {
  log_info "Restoring DNS..."

  if os_restore_dns 2>/dev/null; then
    print_ok "DNS settings restored"
  else
    # Not an error - DNS backup may not exist
    log_info "No DNS backup to restore"
  fi
}

# ============================================================================
# HELP
# ============================================================================

show_help() {
  cat << 'EOF'
velum-disconnect - Disconnect from VPN

USAGE
    sudo velum disconnect

DESCRIPTION
    Cleanly disconnects from the VPN and removes all firewall rules.

    This command:
    1. Stops background health monitor
    2. Stops port forwarding keepalive
    3. Brings down WireGuard interface
    4. Disables kill switch firewall rules
    5. Optionally re-enables IPv6

OPTIONS
    -h, --help    Show this help message

EXAMPLES
    sudo velum disconnect    # Disconnect from VPN

SEE ALSO
    velum connect    # Connect to VPN
    velum status     # Check connection status
EOF
}

# ============================================================================
# MAIN
# ============================================================================

main() {
  # Handle help flag
  case "${1:-}" in
    -h|--help)
      show_help
      exit 0
      ;;
  esac

  echo
  echo "${C_BOLD}velum-disconnect${C_RESET}"
  echo "================"
  echo

  # Require root
  require_root

  # Stop in reverse order of start

  # 0. Stop background monitor
  if [[ -x "$SCRIPT_DIR/velum-monitor" ]]; then
    "$SCRIPT_DIR/velum-monitor" stop >/dev/null 2>&1 || true
  fi

  # 1. Stop port forwarding
  stop_port_forwarding

  # 2. Mark this as an intentional disconnect (so PostDown doesn't send alert)
  ensure_run_dir
  touch "$VELUM_RUN_DIR/intentional-disconnect" 2>/dev/null || true

  # 3. Stop WireGuard (this triggers PostDown which disables kill switch)
  stop_wireguard

  # 4. Clean up the flag
  rm -f "$VELUM_RUN_DIR/intentional-disconnect" 2>/dev/null || true

  # 5. Restore IPv6 (if it was disabled)
  restore_ipv6

  # 6. Restore DNS
  restore_dns

  # 7. Clear session tokens from tmpfs (per security spec)
  credential_clear_all_tokens

  echo
  print_ok "VPN disconnected successfully!"
  echo
  echo "Your internet traffic is no longer protected by the VPN."
  echo
}

main "$@"
