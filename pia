#!/usr/bin/env bash
# PIA WireGuard Wrapper
# Provides clean entry/exit for PIA manual-connections scripts
# Credentials: env vars → Bitwarden → macOS Keychain → prompt

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
KEYCHAIN_SERVICE="PIA-Wrapper"

# Load config from Keychain (encrypted)
get_config() {
  local key="$1"
  security find-generic-password -s "$KEYCHAIN_SERVICE" -a "$key" -w 2>/dev/null || echo ""
}

set_config() {
  local key="$1" value="$2"
  # Delete existing, then add new
  security delete-generic-password -s "$KEYCHAIN_SERVICE" -a "$key" 2>/dev/null || true
  security add-generic-password -s "$KEYCHAIN_SERVICE" -a "$key" -w "$value"
}

# Credential source config (keychain → env vars)
BW_ITEM="${PIA_BW_ITEM:-$(get_config bw_item)}"
BW_SERVER="${PIA_BW_SERVER:-https://vault.bitwarden.eu}"

# Colors
if [[ -t 1 ]]; then
  RED=$(tput setaf 1)
  GREEN=$(tput setaf 2)
  YELLOW=$(tput setaf 3)
  BLUE=$(tput setaf 4)
  NC=$(tput sgr0)
else
  RED='' GREEN='' YELLOW='' BLUE='' NC=''
fi

usage() {
  cat <<EOF
${BLUE}PIA WireGuard Wrapper${NC}

Usage: pia <command> [options]

Commands:
  connect [region]   Connect to VPN (default: auto-select fastest with port forwarding)
  disconnect         Disconnect and clean up
  status             Show connection status
  regions            List available regions

Options:
  --no-pf            Disable port forwarding requirement

Credential Sources (checked in order):
  1. Environment variables: PIA_USER, PIA_PASS
  2. Bitwarden CLI: set PIA_BW_ITEM="item name"
  3. macOS Keychain: set PIA_KEYCHAIN_ACCOUNT="account name"
  4. Interactive prompt (fallback)

Examples:
  pia connect                  # Auto-select best server with port forwarding
  pia connect panama           # Connect to Panama
  pia disconnect               # Clean disconnect
  pia status                   # Check connection status

EOF
}

check_deps() {
  local missing=()
  for cmd in wg-quick curl jq; do
    if ! command -v "$cmd" &>/dev/null; then
      missing+=("$cmd")
    fi
  done

  if [[ ${#missing[@]} -gt 0 ]]; then
    echo "${RED}Missing required tools: ${missing[*]}${NC}"
    echo "Install with: brew install ${missing[*]}"
    exit 1
  fi
}

# --- Credential Sources ---

try_env_vars() {
  if [[ -n "${PIA_USER:-}" && -n "${PIA_PASS:-}" ]]; then
    echo "  Using credentials from environment variables"
    return 0
  fi
  return 1
}

try_bitwarden() {
  command -v bw &>/dev/null || return 1

  # If no item configured, ask on first run
  if [[ -z "$BW_ITEM" ]]; then
    echo "  Bitwarden item not configured."
    read -rp "  Enter Bitwarden item name for PIA (or press Enter to skip): " BW_ITEM
    if [[ -z "$BW_ITEM" ]]; then
      return 1
    fi
    set_config "bw_item" "$BW_ITEM"
    echo "  ${GREEN}Saved to Keychain${NC}"
  fi

  echo "  Trying Bitwarden..."

  # Configure server if needed
  local current_server
  current_server=$(bw config server 2>/dev/null || echo "")
  if [[ "$current_server" != "$BW_SERVER" ]]; then
    bw config server "$BW_SERVER" >/dev/null 2>&1 || return 1
  fi

  # Unlock if needed
  if ! bw unlock --check &>/dev/null; then
    local session
    if ! session=$(bw unlock --raw 2>/dev/null); then
      return 1
    fi
    export BW_SESSION="$session"
  fi

  # Sync and get item
  bw sync &>/dev/null || true
  local item
  if ! item=$(bw get item "$BW_ITEM" 2>/dev/null); then
    return 1
  fi

  PIA_USER=$(echo "$item" | jq -r '.login.username')
  PIA_PASS=$(echo "$item" | jq -r '.login.password')

  if [[ -z "$PIA_USER" || "$PIA_USER" == "null" || -z "$PIA_PASS" || "$PIA_PASS" == "null" ]]; then
    return 1
  fi

  export PIA_USER PIA_PASS
  echo "  ${GREEN}Credentials retrieved from Bitwarden${NC}"
  return 0
}


try_prompt() {
  echo "  No stored credentials found. Please enter manually:"
  echo ""
  read -rp "  PIA Username: " PIA_USER
  read -rsp "  PIA Password: " PIA_PASS
  echo ""

  if [[ -z "$PIA_USER" || -z "$PIA_PASS" ]]; then
    echo "${RED}Credentials required${NC}"
    exit 1
  fi

  export PIA_USER PIA_PASS
  return 0
}

get_credentials() {
  echo "Retrieving credentials..."

  try_env_vars && return 0
  try_bitwarden && return 0
  try_prompt && return 0

  echo "${RED}Failed to retrieve credentials${NC}"
  exit 1
}

# --- Commands ---

do_connect() {
  local region=""
  local port_forward="true"

  while [[ $# -gt 0 ]]; do
    case "$1" in
      --no-pf)
        port_forward="false"
        shift
        ;;
      -*)
        echo "${RED}Unknown option: $1${NC}"
        usage
        exit 1
        ;;
      *)
        region="$1"
        shift
        ;;
    esac
  done

  check_deps
  get_credentials

  echo ""
  echo "${BLUE}Connecting to PIA VPN...${NC}"

  trap 'echo ""; echo "${YELLOW}Interrupted - disconnecting...${NC}"; do_disconnect; exit 130' INT TERM

  cd "$SCRIPT_DIR"

  export PIA_PF="$port_forward"
  export VPN_PROTOCOL="wireguard"
  export PIA_DNS="true"

  if [[ -n "$region" ]]; then
    export PREFERRED_REGION="$region"
  fi

  sudo -E ./get_region.sh
}

do_disconnect() {
  echo "${BLUE}Disconnecting from PIA VPN...${NC}"

  if pkill -f "port_forwarding.sh" 2>/dev/null; then
    echo "  Stopped port forwarding"
  fi

  if sudo wg-quick down pia 2>/dev/null; then
    echo "  WireGuard interface down"
  else
    echo "  ${YELLOW}WireGuard interface was not up${NC}"
  fi

  echo "${GREEN}Disconnected${NC}"
}

do_status() {
  echo "${BLUE}PIA VPN Status${NC}"
  echo ""

  if ! sudo wg show pia &>/dev/null; then
    echo "Status: ${RED}Disconnected${NC}"
    return 0
  fi

  echo "Status: ${GREEN}Connected${NC}"
  echo ""

  echo "${BLUE}WireGuard:${NC}"
  sudo wg show pia | grep -E "interface|peer|endpoint|latest handshake|transfer" | sed 's/^/  /'
  echo ""

  echo "${BLUE}Public IP:${NC}"
  local ip_info
  if ip_info=$(curl -s --max-time 5 https://ipinfo.io/json 2>/dev/null); then
    echo "  IP: $(echo "$ip_info" | jq -r '.ip')"
    echo "  Location: $(echo "$ip_info" | jq -r '.city'), $(echo "$ip_info" | jq -r '.region'), $(echo "$ip_info" | jq -r '.country')"
    echo "  Org: $(echo "$ip_info" | jq -r '.org')"
  else
    echo "  ${YELLOW}Could not retrieve IP info${NC}"
  fi
  echo ""

  if pgrep -f "port_forwarding.sh" &>/dev/null; then
    echo "${BLUE}Port Forwarding:${NC} ${GREEN}Active${NC}"
  else
    echo "${BLUE}Port Forwarding:${NC} ${YELLOW}Inactive${NC}"
  fi
}

do_regions() {
  echo "${BLUE}Fetching PIA regions...${NC}"
  echo ""

  local regions
  regions=$(curl -s "https://serverlist.piaservers.net/vpninfo/servers/v6" | head -1)

  echo "Regions with port forwarding:"
  echo "$regions" | jq -r '.regions[] | select(.port_forward==true) | "  \(.id)\t\(.name)"' | sort
  echo ""
  echo "Use: pia connect <region_id>"
}

# --- Main ---

case "${1:-connect}" in
  connect)
    shift 2>/dev/null || true
    do_connect "$@"
    ;;
  disconnect|dc|down)
    do_disconnect
    ;;
  status|st)
    do_status
    ;;
  regions|list)
    do_regions
    ;;
  -h|--help|help)
    usage
    ;;
  *)
    # Assume it's a region name
    do_connect "$1"
    ;;
esac
